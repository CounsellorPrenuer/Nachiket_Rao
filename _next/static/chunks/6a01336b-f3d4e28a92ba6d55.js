"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[250],{36510:function(e,t,r){r.d(t,{Qc:function(){return eR},ku:function(){return H}});var n=r(11087);class a{matches(e){return this.patternRe.test(e)}toJSON(){return this.pattern}constructor(e){this.pattern=e,this.patternRe=function(e){let t=[];for(let r of e.split("."))"*"===r?t.push("[^.]+"):"**"===r?t.push(".*"):t.push(r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"));return new RegExp("^".concat(t.join("."),"$"))}(e)}}let o=/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?(Z|([-+]\d{2}:\d{2}))$/;function s(e,t){let r=e.toString();for(;r.length<t;)r="0".concat(r);return r}class i{isArray(){return"array"===this.type}async get(){return this.data}asStatic(){return this}[Symbol.asyncIterator](){if(Array.isArray(this.data))return function*(e){for(let t of e)yield m(t)}(this.data);throw Error("Cannot iterate over: ".concat(this.type))}constructor(e,t){this.data=e,this.type=t}}let c=new i(null,"null"),l=new i(!0,"boolean"),p=new i(!1,"boolean");class u{static parseToValue(e){let t=o.test(e)?new Date(e):null;return t?new i(new u(t),"datetime"):c}equals(e){return this.date.getTime()==e.date.getTime()}add(e){let t=new Date(this.date.getTime());return t.setTime(t.getTime()+1e3*e),new u(t)}difference(e){return(this.date.getTime()-e.date.getTime())/1e3}compareTo(e){return this.date.getTime()-e.date.getTime()}toString(){return function(e){let t=s(e.getUTCFullYear(),4),r=s(e.getUTCMonth()+1,2),n=s(e.getUTCDate(),2),a=s(e.getUTCHours(),2),o=s(e.getUTCMinutes(),2),i=s(e.getUTCSeconds(),2),c="",l=e.getMilliseconds();return 0!=l&&(c=".".concat(s(l,3))),"".concat(t,"-").concat(r,"-").concat(n,"T").concat(a,":").concat(o,":").concat(i).concat(c,"Z")}(this.date)}toJSON(){return this.toString()}constructor(e){this.date=e}}function f(e){return Number.isFinite(e)?new i(e,"number"):c}function y(e){return new i(e,"string")}function d(e){return new i(e,"datetime")}function h(e){return new i(e,"array")}function m(e){return e&&"function"==typeof e.next?new g(async function*(){for await(let t of e)yield m(t)}):null==e?c:new i(e,b(e))}function b(e){return null===e||typeof e>"u"?"null":Array.isArray(e)?"array":e instanceof a?"path":e instanceof u?"datetime":typeof e}class g{isArray(){return!0}async get(){let e=[];for await(let t of this)e.push(await t.get());return e}async asStatic(){return new i(await this.get(),"array")}async *[Symbol.asyncIterator](){let e=0;for(;;){for(;e<this.data.length;e++)yield this.data[e];if(this.isDone)return;await this._nextTick()}}_nextTick(){let e,t;if(this.ticker)return this.ticker;let r=()=>{this.ticker=new Promise((r,n)=>{e=r,t=n})},n=()=>{e(),r()},a=async()=>{try{for await(let e of this.generator())this.data.push(e),n();this.isDone=!0,n()}catch(e){t(e)}};return r(),a(),this.ticker}constructor(e){this.type="stream",this.generator=e,this.ticker=null,this.isDone=!1,this.data=[]}}function w(e,t){return"string"===e.type&&"string"===t.type||"boolean"===e.type&&"boolean"===t.type||"null"===e.type&&"null"===t.type||"number"===e.type&&"number"===t.type?e.data===t.data:"datetime"===e.type&&"datetime"===t.type&&e.data.equals(t.data)}function x(e,t){if(null===e||null===t)return e===t;let r=typeof e,n=typeof t;if("undefined"===r&&"undefined"===n)return!0;if("function"===r&&"function"===n)return e===t;if("object"===r&&"object"===n){let r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(let n of r)if(!x(e[n],t[n]))return!1;return!0}return e===t}let k=/([^!@#$%^&*(),\\/?";:{}|[\]+<>\s-])+/g,v=/([^!@#$%^&(),\\/?";:{}|[\]+<>\s-])+/g,_=/(\b\.+|\.+\b)/g;function E(e){return e.replace(_,"").match(k)||[]}function A(e){return(e.replace(_,"").match(v)||[]).map(e=>RegExp("^".concat(e.slice(0,1024).replace(/\*/g,".*"),"$"),"i"))}function S(e,t){if("string"===e.type)return{parts:t(e.data),success:!0};if("array"===e.type){let r=!0,n=[];for(let a of e.data)"string"==typeof a?n.push(...t(a)):r=!1;return{parts:n,success:r}}return"stream"===e.type?(async()=>{let r=!0,n=[];for await(let a of e)"string"===a.type?n.push(...t(a.data)):r=!1;return{parts:n,success:r}})():{parts:[],success:!1}}let j={datetime:1,number:2,string:3,boolean:4};function O(e,t){let r=b(e);if(r!==b(t))return null;switch(r){case"number":case"boolean":return e-t;case"string":return e<t?-1:e>t?1:0;case"datetime":return e.compareTo(t);default:return null}}let C={"==":function(e,t){return w(e,t)?l:p},"!=":function(e,t){return w(e,t)?p:l},">":function(e,t){if("stream"===e.type||"stream"===t.type)return c;let r=O(e.data,t.data);return null===r?c:r>0?l:p},">=":function(e,t){if("stream"===e.type||"stream"===t.type)return c;let r=O(e.data,t.data);return null===r?c:r>=0?l:p},"<":function(e,t){if("stream"===e.type||"stream"===t.type)return c;let r=O(e.data,t.data);return null===r?c:r<0?l:p},"<=":function(e,t){if("stream"===e.type||"stream"===t.type)return c;let r=O(e.data,t.data);return null===r?c:r<=0?l:p},in:function(e,t){if("path"===t.type)return"string"!==e.type?c:t.data.matches(e.data)?l:p;if("array"===t.type){for(let r of t.data)if(w(e,m(r)))return l;return p}return"stream"===t.type?(async()=>{for await(let r of t)if(w(e,r))return l;return p})():c},match:function(e,t){let r=S(e,e=>E(e)),n=S(t,e=>A(e).map(e=>t=>t.some(t=>e.test(t)))),a=(e,t)=>{var r,n;return t.success&&(r=e.parts,n=t.parts,0!==r.length&&0!==n.length&&n.every(e=>e(r)))?l:p};return"then"in r||"then"in n?(async()=>a(await r,await n))():a(r,n)},"+":function(e,t){return"datetime"===e.type&&"number"===t.type?d(e.data.add(t.data)):"number"===e.type&&"datetime"===t.type?d(t.data.add(e.data)):"number"===e.type&&"number"===t.type?f(e.data+t.data):"string"===e.type&&"string"===t.type?y(e.data+t.data):"object"===e.type&&"object"===t.type?m({...e.data,...t.data}):"array"===e.type&&"array"===t.type?m(e.data.concat(t.data)):e.isArray()&&t.isArray()?new g(async function*(){for await(let t of e)yield t;for await(let e of t)yield e}):c},"-":function(e,t){return"datetime"===e.type&&"number"===t.type?d(e.data.add(-t.data)):"datetime"===e.type&&"datetime"===t.type?f(e.data.difference(t.data)):"number"===e.type&&"number"===t.type?f(e.data-t.data):c},"*":I((e,t)=>e*t),"/":I((e,t)=>e/t),"%":I((e,t)=>e%t),"**":I((e,t)=>Math.pow(e,t))};function I(e){return function(t,r){return"number"===t.type&&"number"===r.type?f(e(t.data,r.data)):c}}let T=class e{createNested(t){return this.isHidden?new e(this.params,this.source,t,this.context,this.parent):new e(this.params,this.source,t,this.context,this)}createHidden(e){let t=this.createNested(e);return t.isHidden=!0,t}constructor(e,t,r,n,a){this.isHidden=!1,this.params=e,this.source=t,this.value=r,this.context=n,this.parent=a}};function M(e,t){return G[e.type].executeSync(e,t)}function F(e,t){return G[e.type].executeAsync(e,t)}function P(e){return{executeSync(){throw Error("executeSync not supported")},executeAsync:e}}function N(e){return{executeSync(t,r){let n=e(t,r);if("stream"===n.type)throw Error("Stream encountered in evaluateSync");return n},executeAsync:async(t,r)=>e(t,r)}}function U(e,t){return{executeSync(r,n){let a=e(r).map(e=>M(e,n)),o=t(r,...a);if("stream"===o.type)throw Error("Stream/iterator not supported in synchronous mode");return o},async executeAsync(r,n){let a=e(r);return t(r,...await Promise.all(a.map(e=>F(e,n).then(e=>e.asStatic()))))}}}let D=Symbol();function V(e,t,r,n){return{executeSync(a,o){let{array:s,args:i=[]}=e(a),l=M(s,o);if("array"!==l.type)return c;let p=i.map(e=>M(e,o)),u=t(a,...p);for(let e of l.data){let t=r(a,u,e,...p);if(t===D)return c;u=t}return n(u)},async executeAsync(a,o){let{array:s,args:i=[]}=e(a),l=await F(s,o);if("array"!==l.type&&"stream"!==l.type)return c;let p=await Promise.all(i.map(e=>F(e,o).then(e=>e.asStatic()))),u=t(a,...p);if("stream"===l.type)for await(let e of l){let t=r(a,u,await e.get(),...p);if(t===D)return c;u=t}else for(let e of l.data){let t=r(a,u,e,...p);if(t===D)return c;u=t}return n(u)}}}function q(e,t){let{hidden:r=!1}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return{executeSync(n,a){let o=e(n),s=M(o.array,a);if("array"!==s.type)return c;let i=[];for(let e of s.data){let s;if(o.inner){let t=r?a.createHidden(m(e)):a.createNested(m(e));s=M(o.inner,t).data}for(let r of t(n,e,s,o.state))i.push(r)}return h(i)},async executeAsync(n,a){let o=e(n),s=await F(o.array,a);return s.isArray()?new g(async function*(){for await(let e of s){let s;if(o.inner){let t=r?a.createHidden(e):a.createNested(e);s=await (await F(o.inner,t)).get()}for(let r of t(n,await e.get(),s,o.state))yield m(r)}}):c}}}let G={This:N((e,t)=>t.value),SelectorNested:N(()=>{throw Error("Unexpected node type: SelectorNested")}),SelectorFuncCall:N(()=>{throw Error("Unexpected node type: SelectorFuncCall")}),Everything:N((e,t)=>t.source),Parameter:N((e,t)=>{let{name:r}=e;return m(t.params[r])}),Context:N((e,t)=>{let{key:r}=e;if("before"===r||"after"===r)return t.context[r]||c;throw Error("unknown context key: ".concat(r))}),Parent:N((e,t)=>{let{n:r}=e,n=t;for(let e=0;e<r;e++){if(!n.parent)return c;n=n.parent}return n.value}),OpCall:{async executeAsync(e,t){let{op:r,left:n,right:a}=e,o=C[r];if(!o)throw Error("Unknown operator: ".concat(r));return o(await F(n,t),await F(a,t))},executeSync(e,t){let{op:r,left:n,right:a}=e,o=C[r];if(!o)throw Error("Unknown operator: ".concat(r));let s=o(M(n,t),M(a,t));if("then"in s||"stream"===s.type)throw Error("Operator ".concat(r," not possible in evaluteSync"));return s}},Select:{executeSync(e,t){let{alternatives:r,fallback:n}=e;for(let e of r){let r=M(e.condition,t);if("boolean"===r.type&&!0===r.data)return M(e.value,t)}return n?M(n,t):c},async executeAsync(e,t){let{alternatives:r,fallback:n}=e;for(let e of r){let r=await F(e.condition,t);if("boolean"===r.type&&!0===r.data)return F(e.value,t)}return n?F(n,t):c}},InRange:U(e=>{let{base:t,left:r,right:n}=e;return[t,r,n]},(e,t,r,n)=>{let{isInclusive:a}=e,o=O(t.data,r.data);if(null===o)return c;let s=O(t.data,n.data);return null===s?c:a?o>=0&&s<=0?l:p:o>=0&&s<0?l:p}),Filter:q(e=>{let{base:t,expr:r}=e;return{array:t,inner:r}},function*(e,t,r){!0===r&&(yield t)}),Projection:{executeSync(e,t){let{base:r,expr:n}=e,a=M(r,t);return"object"!==a.type?c:M(n,t.createNested(a))},async executeAsync(e,t){let{base:r,expr:n}=e,a=await F(r,t);return"object"!==a.type?c:F(n,t.createNested(a))}},FuncCall:{executeAsync(e,t){let{func:r,args:n}=e;return r.executeAsync(n,t)},executeSync(e,t){let{func:r,args:n}=e;return r.executeSync(n,t)}},PipeFuncCall:{async executeAsync(e,t){let{func:r,base:n,args:a}=e,o=await F(n,t);return"stream"!==o.type&&"array"!==o.type?c:r.executeAsync({base:o,args:a},t)},executeSync(e,t){let{func:r,base:n,args:a}=e,o=M(n,t);return"array"!==o.type?c:r.executeSync({base:o,args:a},t)}},AccessAttribute:U(e=>{let{base:t}=e;return[t||{type:"This"}]},(e,t)=>{let{name:r}=e;return"object"===t.type&&t.data.hasOwnProperty(r)?m(t.data[r]):c}),AccessElement:U(e=>{let{base:t}=e;return[t]},(e,t)=>{let{index:r}=e;if("array"!==t.type)return c;let n=t.data,a=r<0?r+n.length:r;return m(n[a])}),Slice:U(e=>{let{base:t}=e;return[t]},(e,t)=>{let{left:r,right:n,isInclusive:a}=e;if("array"!==t.type)return c;let o=t.data,s=r,i=n;return s<0&&(s=o.length+s),i<0&&(i=o.length+i),a&&i++,s<0&&(s=0),i<0&&(i=0),h(o.slice(s,i))}),Deref:{executeSync(e,t){let{base:r}=e,n=M(r,t);if("object"!==n.type)return c;let a=n.data._ref;if("string"!=typeof a)return c;if(t.context.dereference){let e=t.context.dereference({_ref:a});if(e&&"object"==typeof e&&"then"in e)throw Error("Dereference returned promise in synchronous mode");return m(e)}if("array"!==t.source.type)return c;for(let e of t.source.data)if(e&&"object"==typeof e&&"_id"in e&&a===e._id)return m(e);return c},async executeAsync(e,t){let{base:r}=e,n=await F(r,t);if(!t.source.isArray()||"object"!==n.type)return c;let a=n.data._ref;if("string"!=typeof a)return c;if(t.context.dereference)return m(await t.context.dereference({_ref:a}));for await(let e of t.source)if("object"===e.type&&a===e.data._id)return e;return c}},Value:N(e=>{let{value:t}=e;return m(t)}),Group:{executeSync(e,t){let{base:r}=e;return M(r,t)},executeAsync(e,t){let{base:r}=e;return F(r,t)}},Object:{executeSync(e,t){let{attributes:r}=e,n={};for(let e of r){let r=e.type;switch(e.type){case"ObjectAttributeValue":{let r=M(e.value,t);n[e.name]=r.data;break}case"ObjectConditionalSplat":{let r=M(e.condition,t);if("boolean"!==r.type||!1===r.data)continue;let a=M(e.value,t);"object"===a.type&&Object.assign(n,a.data);break}case"ObjectSplat":{let r=M(e.value,t);"object"===r.type&&Object.assign(n,r.data);break}default:throw Error("Unknown node type: ".concat(r))}}return m(n)},async executeAsync(e,t){let{attributes:r}=e,n={};for(let e of r){let r=e.type;switch(e.type){case"ObjectAttributeValue":{let r=await F(e.value,t);n[e.name]=await r.get();break}case"ObjectConditionalSplat":{let r=await F(e.condition,t);if("boolean"!==r.type||!1===r.data)continue;let a=await F(e.value,t);"object"===a.type&&Object.assign(n,a.data);break}case"ObjectSplat":{let r=await F(e.value,t);"object"===r.type&&Object.assign(n,r.data);break}default:throw Error("Unknown node type: ".concat(r))}}return m(n)}},Array:{executeSync(e,t){let{elements:r}=e,n=[];for(let e of r){let r=M(e.value,t);if(e.isSplat){if("array"===r.type)for(let e of r.data)n.push(e)}else n.push(r.data)}return h(n)},async executeAsync(e,t){let{elements:r}=e;return new g(async function*(){for(let e of r){let r=await F(e.value,t);if(e.isSplat){if(r.isArray())for await(let e of r)yield e}else yield r}})}},Tuple:N(()=>{throw Error("tuples can not be evaluated")}),Or:U(e=>{let{left:t,right:r}=e;return[t,r]},(e,t,r)=>"boolean"===t.type&&!0===t.data||"boolean"===r.type&&!0===r.data?l:"boolean"!==t.type||"boolean"!==r.type?c:p),And:U(e=>{let{left:t,right:r}=e;return[t,r]},(e,t,r)=>"boolean"===t.type&&!1===t.data||"boolean"===r.type&&!1===r.data?p:"boolean"!==t.type||"boolean"!==r.type?c:l),Not:U(e=>{let{base:t}=e;return[t]},(e,t)=>"boolean"!==t.type?c:t.data?p:l),Neg:U(e=>{let{base:t}=e;return[t]},(e,t)=>"number"!==t.type?c:f(-t.data)),Pos:U(e=>{let{base:t}=e;return[t]},(e,t)=>"number"!==t.type?c:f(t.data)),Asc:N(()=>c),Desc:N(()=>c),ArrayCoerce:{executeSync(e,t){let{base:r}=e,n=M(r,t);return n.isArray()?n:c},async executeAsync(e,t){let{base:r}=e,n=await F(r,t);return n.isArray()?n:c}},Map:q(e=>{let{base:t,expr:r}=e;return{array:t,inner:r}},function*(e,t,r){yield r},{hidden:!0}),FlatMap:q(e=>{let{base:t,expr:r}=e;return{array:t,inner:r}},function*(e,t,r){if(Array.isArray(r))for(let e of r)yield e;else yield r},{hidden:!0})};function H(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return F(e,function(e){let t=m(e.root),r=m(e.dataset);return new T({...e.params},r,t,{timestamp:e.timestamp||new Date,identity:void 0===e.identity?"me":e.identity,sanity:e.sanity,after:e.after?m(e.after):null,before:e.before?m(e.before):null,dereference:e.dereference},null)}(t))}let R=new T({},c,c,{timestamp:new Date(0),identity:"me",before:null,after:null},null);function $(e){return!function e(t){switch(t.type){case"Group":case"Pos":case"Neg":return e(t.base);case"Value":case"Parameter":return!0;case"OpCall":switch(t.op){case"+":case"-":case"*":case"/":case"%":case"**":return e(t.left)&&e(t.right);default:return!1}default:return!1}}(e)?null:M(e,R)}function B(e){return["AccessAttribute","SelectorFuncCall","Group","Tuple","ArrayCoerce","Filter","SelectorNested"].includes(e.type)}let Z={};Z.join=U(e=>e,(e,t,r)=>{if("array"!==t.type||"string"!==r.type)return c;let n="",a=!1;for(let e of t.data){switch(a&&(n+=r.data),b(e)){case"number":case"string":case"boolean":case"datetime":n+="".concat(e);break;default:return c}a=!0}return y(n)}),Z.join.arity=2,Z.compact=q(e=>{let[t]=e;return{array:t}},function*(e,t){null!==t&&(yield t)}),Z.compact.arity=1,Z.unique=q(e=>({array:e[0],state:new Set}),function*(e,t,r,n){switch(b(t)){case"number":case"string":case"boolean":case"datetime":n.has(t)||(n.add(t),yield t);break;default:yield t}}),Z.unique.arity=1,Z.intersects=U(e=>e,(e,t,r)=>{if("array"!==t.type||"array"!==r.type)return c;for(let e of t.data)for(let t of r.data)if(w(m(e),m(t)))return l;return p}),Z.intersects.arity=2;let z={};async function Q(e,t){let r=await e.get();for(let e of t)if(!(r=function(e,t){try{return e[t]}catch(e){return}}(r,e)))break;return r}async function*W(e,t){let r=[[]];for(;r.length>0;){let n=r.shift()||[],a=m(await Q(e,n)),o=m(await Q(t,n));if(o.type!==a.type)yield n;else if("string"===o.type&&"string"===a.type||"boolean"===o.type&&"boolean"===a.type||"null"===o.type&&"null"===a.type||"number"===o.type&&"number"===a.type)o.data!==a.data&&(yield n);else if("datetime"===o.type&&"datetime"===a.type)o.data.equals(a.data)||(yield n);else if("object"===o.type&&"object"===a.type){if(!x(o.data,a.data)){let e=Object.keys(o.data),t=Object.keys(a.data);new Set(e.concat(t)).forEach(e=>{r.push([...n,e])})}}else if("array"===o.type&&"array"===a.type){if(o.data.length!==a.data.length)yield n;else if(!x(o.data,a.data))for(let e=0;e<a.data.length;e++)r.push([...n,e])}else if("stream"===o.type&&"stream"===a.type){let e=await o.get(),t=await a.get();if(e.length!==t.length)yield n;else if(!x(e,t))for(let e=0;e<t.length;e++)r.push([...n,e])}}}async function J(e,t,r){switch(e.type){case"Group":return await J(e.base,t,r);case"Tuple":let n=[];for(let a of e.members){let e=await J(a,t,r);n.push(...e)}return n;case"AccessAttribute":return e.base?(await J(e.base,t,r)).map(t=>[...t,e.name]):[[e.name]];case"ArrayCoerce":{let n=await J(e.base,t,r),a=[];for(let e of n){let r=await Q(t,e);if(Array.isArray(r))for(let t=0;t<r.length;t++)a.push([...e,t])}return a}case"Filter":{let n=await J(e.base,t,r),a={...e,base:{type:"This"}},o=[];for(let e of n){let n=await Q(t,e);if(Array.isArray(n))for(let t=0;t<n.length;t++){let s=n[t],i=r.createNested(m([s]));(await (await F(a,i)).get()).length>0&&o.push([...e,t])}}return o}case"SelectorFuncCall":return L(e.arg,r.createHidden(t));case"SelectorNested":{let{base:n,nested:a}=e,o=await J(n,t,r),s=[];for(let e of o){let n=await Q(t,e);switch(a.type){case"AccessAttribute":case"ArrayCoerce":case"Filter":let o=await J(a,m(n),r);for(let t=0;t<o.length;t++)s.push([...e,...o[t]]);break;case"Group":for(let t of(await J(a.base,m(n),r)))s.push([...e,...t]);break;case"Tuple":for(let t of a.members)for(let a of(await J(t,m(n),r)))s.push([...e,...a])}}return s}}}async function L(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=t.value,a=[];if(n.isArray()){let o=await n.get();for(let n=0;n<o.length;n++){let s=await L(e,t.createHidden(m(o[n])),[...r,n]);a.push(...s)}}else if("object"===n.type){let o=await F(e,t);for(let s of("boolean"===o.type&&!0===o.data&&a.push(r),Object.keys(n.data))){let o=await L(e,t.createHidden(m(n.data[s])),[...r,s]);a.push(...o)}}return a}async function Y(e,t,r,n){let a=n.createHidden(e),o=await J(r,a.value,a),s=n.createHidden(t),i=await J(r,s.value,s);if(o.length!==i.length)return l;for(let r of o){for(let n=0;n<r.length;n++)if("number"==typeof r[n]){let a=r.slice(0,n),o=await Q(e,a),s=await Q(t,a);if(!Array.isArray(o)||!Array.isArray(s)||o.length!==s.length)return l}if(!x(await Q(e,r),await Q(t,r)))return l}return p}async function K(e,t,r,n){let a=n.createHidden(e),o=await J(r,a.value,a);for await(let r of W(e,t)){let e=!1;for(let t of o)if(function(e,t){return t.every((t,r)=>e[r]===t)}(r,t)){e=!0;break}if(!e)return p}return l}z.now=N((e,t)=>d(new u(t.context.timestamp))),z.now.arity=0;let X={};X.changedAny=P(async(e,t)=>{let r=e[0],n=e[1],a=e[2];if(!B(a))throw Error("changedAny third argument must be a selector");return Y(await F(r,t),await F(n,t),a,t)}),X.changedAny.arity=3,X.changedOnly=P(async(e,t)=>{let r=e[0],n=e[1],a=e[2];if(!B(a))throw Error("changedOnly third argument must be a selector");return K(await F(r,t),await F(n,t),a,t)}),X.changedOnly.arity=3;let ee={};ee.operation=N((e,t)=>{let r=null!==t.context.before,n=null!==t.context.after;return r&&n?y("update"):n?y("create"):r?y("delete"):c}),ee.changedAny=P(async(e,t)=>{let r=t.context.before||c,n=t.context.after||c,a=e[0];if(!B(a))throw Error("changedAny first argument must be a selector");return Y(r,n,a,t)}),ee.changedAny.arity=1,ee.changedAny.mode="delta",ee.changedOnly=P(async(e,t)=>{let r=t.context.before||c,n=t.context.after||c,a=e[0];if(!B(a))throw Error("changedOnly first argument must be a selector");return K(r,n,a,t)}),ee.changedOnly.arity=1,ee.changedOnly.mode="delta";let et={};et.get=N(()=>{throw Error("not implemented")}),et.incomingRefCount=N(()=>{throw Error("not implemented")}),et.incomingGlobalDocumentReferenceCount=N(()=>{throw Error("not implemented")});let er={};er.latLng=N(()=>{throw Error("not implemented")}),er.contains=N(()=>{throw Error("not implemented")}),er.intersects=N(()=>{throw Error("not implemented")}),er.distance=N(()=>{throw Error("not implemented")});let en={};en.lower=U(e=>e,(e,t)=>"string"!==t.type?c:y(t.data.toLowerCase())),en.lower.arity=1,en.upper=U(e=>e,(e,t)=>"string"!==t.type?c:y(t.data.toUpperCase())),en.upper.arity=1,en.split=U(e=>e,(e,t,r)=>"string"!==t.type||"string"!==r.type?c:0===t.data.length?h([]):0===r.data.length?h(Array.from(t.data)):h(t.data.split(r.data))),en.split.arity=2,en.startsWith=U(e=>e,(e,t,r)=>"string"!==t.type||"string"!==r.type?c:t.data.startsWith(r.data)?l:p),en.startsWith.arity=2;let ea={};ea.anywhere=N(()=>{throw Error("not implemented")}),ea.anywhere.arity=1,ea.coalesce={async executeAsync(e,t){for(let r of e){let e=await F(r,t);if("null"!==e.type)return e}return c},executeSync(e,t){for(let r of e){let e=M(r,t);if("null"!==e.type)return e}return c}},ea.count=V(e=>({array:e[0]}),()=>0,(e,t)=>t+1,f),ea.count.arity=1,ea.dateTime=U(e=>e,(e,t)=>"datetime"===t.type?t:"string"!==t.type?c:u.parseToValue(t.data)),ea.dateTime.arity=1,ea.defined=U(e=>e,(e,t)=>"null"===t.type?p:l),ea.defined.arity=1,ea.identity=N((e,t)=>y(t.context.identity)),ea.identity.arity=0,ea.length=U(e=>e,(e,t)=>"string"===t.type?f(function(e){let t=0;for(let r=0;r<e.length;r++){let n=e.charCodeAt(r);n>=55296&&n<=56319||t++}return t}(t.data)):"array"===t.type?f(t.data.length):c),ea.length.arity=1,ea.path=U(e=>e,(e,t)=>"string"!==t.type?c:new i(new a(t.data),"path")),ea.path.arity=1,ea.string=U(e=>e,(e,t)=>{switch(t.type){case"number":case"string":case"boolean":case"datetime":return y("".concat(t.data));default:return c}}),ea.string.arity=1,ea.references=U(e=>[{type:"This"},...e],function(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),a=2;a<r;a++)n[a-2]=arguments[a];let o=new Set;for(let e of n)if("string"===e.type)o.add(e.data);else if("array"===e.type)for(let t of e.data)"string"==typeof t&&o.add(t);return 0===o.size?p:!function e(t,r){switch(b(t)){case"array":for(let n of t)if(e(n,r))return!0;break;case"object":if(t._ref)return r.has(t._ref);for(let n of Object.values(t))if(e(n,r))return!0}return!1}(t,o)?p:l}),ea.references.arity=e=>e>=1,ea.round=U(e=>e,(e,t,r)=>{if("number"!==t.type)return c;let n=t.data,a=0;if(r){if("number"!==r.type||r.data<0||!Number.isInteger(r.data))return c;a=r.data}return 0===a?n<0?f(-Math.round(-n)):f(Math.round(n)):f(Number(n.toFixed(a)))}),ea.round.arity=e=>e>=1&&e<=2,ea.now=N((e,t)=>y(t.context.timestamp.toISOString())),ea.now.arity=0,ea.boost=N(()=>{throw Error("unexpected boost call")}),ea.boost.arity=2,ea.lower=en.lower,ea.upper=en.upper;let eo={};eo.min=V(e=>({array:e[0]}),()=>{},(e,t,r)=>null===r?t:"number"!=typeof r?D:void 0===t||r<t?r:t,e=>void 0===e?c:f(e)),eo.min.arity=1,eo.max=V(e=>({array:e[0]}),()=>{},(e,t,r)=>null===r?t:"number"!=typeof r?D:void 0===t||r>t?r:t,e=>void 0===e?c:f(e)),eo.max.arity=1,eo.sum=V(e=>({array:e[0]}),()=>0,(e,t,r)=>null===r?t:"number"!=typeof r?D:t+r,f),eo.sum.arity=1,eo.avg=V(e=>({array:e[0]}),()=>({count:0,sum:0}),(e,t,r)=>{let{count:n,sum:a}=t;return null===r?{count:n,sum:a}:"number"!=typeof r?D:{count:n+1,sum:a+r}},e=>{let{count:t,sum:r}=e;return 0===t?c:f(r/t)}),eo.avg.arity=1;let es={};function ei(e){if("string"!=typeof e._type)return null;let t=e.children;if(!Array.isArray(t))return null;let r="";for(let e of t)e&&"object"==typeof e&&"string"==typeof e._type&&"span"===e._type&&"string"==typeof e.text&&(r+=e.text);return r}es.aspect=N(()=>{throw Error("not implemented")}),es.aspect.arity=2;let ec={};ec.text=U(e=>e,function(e,t){let r=function(e){if("object"===e.type)return ei(e.data);if("array"===e.type){let t=function e(t){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];for(let n of t)if(Array.isArray(n))e(n,r);else if("object"==typeof n&&n){let e=ei(n);null!==e&&r.push(e)}return r}(e.data);if(t.length>0)return t.join("\n\n")}return null}(t);return null===r?c:y(r)}),ec.text.arity=1;let el={};el.all=q(()=>({array:{type:"Everything"}}),function*(e,t){"object"==typeof t&&t&&"_type"in t&&"system.release"===t._type&&(yield t)}),el.all.arity=0;let ep={};ep.projectId=N((e,t)=>t.context.sanity?y(t.context.sanity.projectId):c),ep.dataset=N((e,t)=>t.context.sanity?y(t.context.sanity.dataset):c),ep.versionOf=U(e=>{let[t]=e;return[t,{type:"This"}]},(e,t,r)=>{if("string"!==t.type)return c;let n=t.data;if("object"!==r.type||"string"!=typeof r.data._id)return c;if(r.data._id===n)return l;let a=r.data._id.split(".");return a.length>=2&&"drafts"===a[0]&&a.slice(1).join(".")===n||a.length>=3&&"versions"===a[0]&&a.slice(2).join(".")===n?l:p}),ep.versionOf.arity=1,ep.partOfRelease=U(e=>[e[0],{type:"This"}],(e,t,r)=>{if("string"!==t.type)return c;let n=t.data;if("object"!==r.type||"string"!=typeof r.data._id)return c;let a=r.data._id.split(".");return a.length>=3&&"versions"===a[0]&&a[1]===n?l:p}),ep.partOfRelease.arity=1;let eu={};async function ef(e,t){if("OpCall"===e.type&&"match"===e.op)return ey(e.left,e.right,t);if("FuncCall"===e.type&&"boost"===e.name){let r=await ef(e.args[0],t),n=await F(e.args[1],t);return"number"===n.type&&r>0?r+n.data:0}switch(e.type){case"Or":return await ef(e.left,t)+await ef(e.right,t);case"And":{let r=await ef(e.left,t),n=await ef(e.right,t);return 0===r||0===n?0:r+n}default:{let r=await F(e,t);return"boolean"===r.type&&!0===r.data?1:0}}}async function ey(e,t,r){return ed(await F(e,r),await F(t,r))}function ed(e,t){let r=S(e,e=>E(e)),n=S(t,e=>A(e)),a=(e,t)=>{if(!t.success||0===e.parts.length||0===t.parts.length)return 0;let r=0;for(let n of t.parts){let t=e.parts.reduce((e,t)=>e+(n.test(t)?1:0),0);r+=2.2*t/(t+1.2)}return r};return"then"in r||"then"in n?(async()=>a(await r,await n))():a(r,n)}function eh(e){let t=[],r=[];for(let n of e){let e="asc";"Desc"===n.type?(e="desc",n=n.base):"Asc"===n.type&&(n=n.base),t.push(n),r.push(e)}return{mappers:t,directions:r}}function em(e,t){return e.sort((e,r)=>{for(let n=0;n<t.length;n++){let a=function(e,t){let r=b(e),n=b(t),a=j[r]||100,o=j[n]||100;if(a!==o)return a-o;let s=O(e,t);return null===s&&(s=0),s}(e[n+2],r[n+2]);if("desc"===t[n]&&(a=-a),0!==a)return a}return e[1]-r[1]}),e.map(e=>e[0])}eu.query=N(()=>{throw Error("not implemented")}),eu.query.arity=1,eu.embedding=N(()=>{throw Error("not implemented")}),eu.embedding.arity=1;let eb={};eb.order={executeSync(e,t){let{base:r,args:n}=e,{mappers:a,directions:o}=eh(n),s=[],i=0,c=o.length;for(let e of r.data){let r=t.createNested(m(e)),n=[e,i];for(let e=0;e<c;e++){let t=M(a[e],r);n.push(t.data)}s.push(n),i++}return h(em(s,o))},async executeAsync(e,t){let{base:r,args:n}=e,{mappers:a,directions:o}=eh(n),s=[],i=0,c=o.length;for await(let e of r){let r=t.createNested(e),n=[await e.get(),i];for(let e=0;e<c;e++){let t=await F(a[e],r);n.push(await t.get())}s.push(n),i++}return h(em(s,o))}},eb.order.arity=e=>e>=1,eb.score={async executeAsync(e,t){let{base:r,args:n}=e,a=[],o=[];for await(let e of r){if("object"!==e.type){a.push(await e.get());continue}let r=t.createNested(e),s="number"==typeof e.data._score?e.data._score:0;for(let e of n)s+=await ef(e,r);let i=Object.assign({},e.data,{_score:s});o.push(i)}return o.sort((e,t)=>t._score-e._score),m(o)},executeSync(e,t){let{base:r,args:n}=e,a=[];for(let e of r.data){if("object"!==b(e))continue;let r=t.createNested(m(e)),o="number"==typeof e._score?e._score:0;for(let e of n)o+=function e(t,r){if("OpCall"===t.type&&"match"===t.op)return function(e,t,r){let n=ed(M(e,r),M(t,r));if("number"==typeof n)return n;throw Error("Found synchronous value in match()")}(t.left,t.right,r);if("FuncCall"===t.type&&"boost"===t.name){let n=e(t.args[0],r),a=M(t.args[1],r);return"number"===a.type&&n>0?n+a.data:0}switch(t.type){case"Or":return e(t.left,r)+e(t.right,r);case"And":{let n=e(t.left,r),a=e(t.right,r);return 0===n||0===a?0:n+a}default:{let e=M(t,r);return"boolean"===e.type&&!0===e.data?1:0}}}(e,r);let s=Object.assign({},e,{_score:o});a.push(s)}return a.sort((e,t)=>t._score-e._score),h(a)}},eb.score.arity=e=>e>=1;let eg={global:ea,string:en,array:Z,pt:ec,delta:ee,diff:X,media:es,sanity:ep,math:eo,dateTime:z,releases:el,text:eu,geo:er,documents:et};class ew{hasMark(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.index+e<this.marks.length}getMark(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.marks[this.index+e]}shift(){this.index+=1}process(e){let t=this.marks[this.index];this.shift();let r=e[t.name];if(!r)throw Error("Unknown handler: ".concat(t.name));return r.call(e,this,t)}processString(){return this.shift(),this.processStringEnd()}processStringEnd(){let e=this.marks[this.index-1],t=this.marks[this.index];return this.shift(),this.string.slice(e.position,t.position)}slice(e){let t=this.marks[this.index].position;return this.string.slice(t,t+e)}get string(){return this._string}constructor(e,t,r,n){this.allowBoost=!1,this._string=e,this.marks=t,this.customFunctions=r,this.index=0,this.parseOptions=n}}let ex=/^([\t\n\v\f\r \u0085\u00A0]|(\/\/[^\n]*\n))+/,ek=/^\d+/,ev=/^[a-zA-Z_][a-zA-Z_0-9]*/;function e_(e,t,r){let n=t,a;switch(e[t]){case"+":{let r=e_(e,eO(e,t+1),10);if("error"===r.type)return r;a=[{name:"pos",position:n}].concat(r.marks),t=r.position;break}case"-":{let r=e_(e,eO(e,t+1),8);if("error"===r.type)return r;a=[{name:"neg",position:n}].concat(r.marks),t=r.position;break}case"(":{let r=eE(e,t);if("error"===r.type)return r;t=r.position,a=r.marks;break}case"!":{let r=e_(e,eO(e,t+1),10);if("error"===r.type)return r;a=[{name:"not",position:n}].concat(r.marks),t=r.position;break}case"{":{let r=ej(e,t);if("error"===r.type)return r;a=r.marks,t=r.position;break}case"[":if(a=[{name:"array",position:t}],t=eO(e,t+1),"]"!==e[t])for(;;){"..."===e.slice(t,t+3)&&(a.push({name:"array_splat",position:t}),t=eO(e,t+3));let r=e_(e,t,0);if("error"===r.type)return r;if(a=a.concat(r.marks),t=eO(e,t=r.position),","!==e[t]||(t=eO(e,t+1),"]"===e[t]))break}if("]"!==e[t])return{type:"error",message:'Expected "]" after array expression',position:t};t++,a.push({name:"array_end",position:t});break;case"'":case'"':{let r=function(e,t){let r=e[t],n=[{name:"str",position:t+=1}];e:for(;;t++){if(t>e.length)return{type:"error",message:"Unexpected end of query",position:t};switch(e[t]){case r:n.push({name:"str_end",position:t}),t++;break e;case"\\":n.push({name:"str_pause",position:t}),"u"===e[t+1]?"{"===e[t+2]?(n.push({name:"unicode_hex",position:t+3}),t=e.indexOf("}",t+3),n.push({name:"unicode_hex_end",position:t})):(n.push({name:"unicode_hex",position:t+2}),n.push({name:"unicode_hex_end",position:t+6}),t+=5):(n.push({name:"single_escape",position:t+1}),t+=1),n.push({name:"str_start",position:t+1})}}return{type:"success",marks:n,position:t}}(e,t);if("error"===r.type)return r;a=r.marks,t=r.position;break}case"^":for(t++,a=[];"."===e[t]&&"^"===e[t+1];)a.push({name:"dblparent",position:n}),t+=2;a.push({name:"parent",position:n});break;case"@":a=[{name:"this",position:n}],t++;break;case"*":a=[{name:"everything",position:n}],t++;break;case"$":{let r=eC(e,t+1,ev);r&&(t+=1+r,a=[{name:"param",position:n},{name:"ident",position:n+1},{name:"ident_end",position:t}]);break}default:{let r=eC(e,t,ek);if(r){let o="integer";if("."===e[t+=r]){let r=eC(e,t+1,ek);r&&(o="float",t+=1+r)}if("e"===e[t]||"E"===e[t]){o="sci",("+"===e[++t]||"-"===e[t])&&t++;let r=eC(e,t,ek);if(!r)return{type:"error",message:"Exponent must be a number",position:t};t+=r}a=[{name:o,position:n},{name:o+"_end",position:t}];break}let o=eC(e,t,ev);if(o)switch(e[t+=o]){case":":case"(":{let r=eS(e,n,t);if("error"===r.type)return r;a=r.marks,t=r.position;break}default:a=[{name:"this_attr",position:n},{name:"ident",position:n},{name:"ident_end",position:t}]}}}if(!a)return{type:"error",message:"Expected expression",position:t};let o=12,s;t:for(;;){let i=eO(e,t);if(i===e.length){t=i;break}if("success"===(s=eA(e,i)).type){for(a.unshift({name:"traverse",position:n});"success"===s.type;)a=a.concat(s.marks),s=eA(e,eO(e,t=s.position));a.push({name:"traversal_end",position:t});continue}switch(e[i]){case"=":switch(e[i+1]){case">":{if(r>1||o<=1)break t;let s=e_(e,eO(e,i+2),1);if("error"===s.type)return s;(a=a.concat(s.marks)).unshift({name:"pair",position:n}),t=s.position,o=1;break}case"=":{if(r>4||o<=4)break t;let s=e_(e,eO(e,i+2),5);if("error"===s.type)return s;a.unshift({name:"comp",position:n}),a.push({name:"op",position:i},{name:"op_end",position:i+2}),a=a.concat(s.marks),t=s.position,o=4;break}default:break t}break;case"+":{if(r>6||o<6)break t;let s=e_(e,eO(e,i+1),7);if("error"===s.type)return s;(a=a.concat(s.marks)).unshift({name:"add",position:n}),t=s.position,o=6;break}case"-":{if(r>6||o<6)break t;let s=e_(e,eO(e,i+1),7);if("error"===s.type)return s;(a=a.concat(s.marks)).unshift({name:"sub",position:n}),t=s.position,o=6;break}case"*":{if("*"===e[i+1]){if(r>8||o<=8)break t;let s=e_(e,eO(e,i+2),8);if("error"===s.type)return s;(a=a.concat(s.marks)).unshift({name:"pow",position:n}),t=s.position,o=8;break}if(r>7||o<7)break t;let s=e_(e,eO(e,i+1),8);if("error"===s.type)return s;(a=a.concat(s.marks)).unshift({name:"mul",position:n}),t=s.position,o=7;break}case"/":{if(r>7||o<7)break t;let s=e_(e,eO(e,i+1),8);if("error"===s.type)return s;(a=a.concat(s.marks)).unshift({name:"div",position:n}),t=s.position,o=7;break}case"%":{if(r>7||o<7)break t;let s=e_(e,eO(e,i+1),8);if("error"===s.type)return s;(a=a.concat(s.marks)).unshift({name:"mod",position:n}),t=s.position,o=7;break}case"<":case">":{if(r>4||o<=4)break t;let s=i+1;"="===e[s]&&s++;let c=e_(e,eO(e,s),5);if("error"===c.type)return c;a.unshift({name:"comp",position:n}),a.push({name:"op",position:i},{name:"op_end",position:s}),a=a.concat(c.marks),t=c.position,o=4;break}case"|":if("|"===e[i+1]){if(r>2||o<2)break t;let s=e_(e,eO(e,i+2),3);if("error"===s.type)return s;(a=a.concat(s.marks)).unshift({name:"or",position:n}),t=s.position,o=2}else{if(r>11||o<11)break t;let s=eO(e,i+1),c=eC(e,s,ev);if(!c)return{type:"error",message:"Expected identifier",position:s};if("("===e[t=s+c]||":"===e[t]){let r=eS(e,s,t);if("error"===r.type)return r;(a=a.concat(r.marks)).unshift({name:"pipecall",position:n}),t=r.position,o=11}}break;case"&":{if("&"!=e[i+1]||r>3||o<3)break t;let s=e_(e,eO(e,i+2),4);if("error"===s.type)return s;(a=a.concat(s.marks)).unshift({name:"and",position:n}),t=s.position,o=3;break}case"!":{if("="!==e[i+1]||r>4||o<=4)break t;let s=e_(e,eO(e,i+2),5);if("error"===s.type)return s;a.unshift({name:"comp",position:n}),a.push({name:"op",position:i},{name:"op_end",position:i+2}),a=a.concat(s.marks),t=s.position,o=4;break}case"d":if("desc"!==e.slice(i,i+4)||r>4||o<4)break t;a.unshift({name:"desc",position:n}),t=i+4,o=4;break;case"a":if("asc"!==e.slice(i,i+3)||r>4||o<4)break t;a.unshift({name:"asc",position:n}),t=i+3,o=4;break;default:switch(eI(e,i,ev)){case"in":{if(r>4||o<=4)break t;t=eO(e,i+2);let s=!1;"("===e[t]&&(s=!0,t=eO(e,t+1));let c=t,l=e_(e,t,5);if("error"===l.type)return l;if(t=eO(e,l.position),"."===e[t]&&"."===e[t+1]){let r="inc_range";"."===e[t+2]?(r="exc_range",t=eO(e,t+3)):t=eO(e,t+2);let o=e_(e,t,5);if("error"===o.type)return o;a.unshift({name:"in_range",position:n}),a=a.concat({name:r,position:c},l.marks,o.marks),t=o.position}else a.unshift({name:"comp",position:n}),a.push({name:"op",position:i},{name:"op_end",position:i+2}),a=a.concat(l.marks);if(s){if(t=eO(e,t),")"!==e[t])return{type:"error",message:'Expected ")" in group',position:t};t++}o=4;break}case"match":{if(r>4||o<=4)break t;let s=e_(e,eO(e,i+5),5);if("error"===s.type)return s;a.unshift({name:"comp",position:n}),a.push({name:"op",position:i},{name:"op_end",position:i+5}),a=a.concat(s.marks),t=s.position,o=4;break}default:break t}}}return{type:"success",marks:a,position:t,failPosition:(null==s?void 0:s.type)==="error"&&s.position}}function eE(e,t){let r=t,n,a=e_(e,eO(e,t+1),0);if("error"===a.type)return a;switch(t=eO(e,a.position),e[t]){case",":for(n=[{name:"tuple",position:r}].concat(a.marks),t=eO(e,t+1);;){if("error"===(a=e_(e,t,0)).type)return a;if(n.push(...a.marks),t=eO(e,a.position),","!==e[t])break;t=eO(e,t+1)}if(")"!==e[t])return{type:"error",message:'Expected ")" after tuple expression',position:t};t++,n.push({name:"tuple_end",position:t});break;case")":t++,n=[{name:"group",position:r}].concat(a.marks);break;default:return{type:"error",message:'Unexpected character "'.concat(e[t],'"'),position:t}}return{type:"success",marks:n,position:t}}function eA(e,t){let r=t;switch(e[t]){case".":{if(t=eO(e,t+1),"("===e[t])return eE(e,t);let n=t,a=eC(e,t,ev);return a?{type:"success",marks:[{name:"attr_access",position:r},{name:"ident",position:n},{name:"ident_end",position:t+=a}],position:t}:{type:"error",message:'Expected identifier after "."',position:t}}case"-":if(">"!==e[t+1])return{type:"error",message:'Expected ">" in reference',position:t};let n=[{name:"deref",position:r}],a=eO(e,t+=2),o=eC(e,a,ev);return o&&(t=a+o,n.push({name:"deref_attr",position:a},{name:"ident",position:a},{name:"ident_end",position:t})),{type:"success",marks:n,position:t};case"[":{if(t=eO(e,t+1),"]"===e[t])return{type:"success",marks:[{name:"array_postfix",position:r}],position:t+1};let n=t,a=e_(e,t,0);if("error"===a.type)return a;if(t=eO(e,a.position),"."===e[t]&&"."===e[t+1]){let o="inc_range";"."===e[t+2]?(o="exc_range",t+=3):t+=2,t=eO(e,t);let s=e_(e,t,0);return"error"===s.type?s:(t=eO(e,s.position),"]"!==e[t]?{type:"error",message:'Expected "]" after array expression',position:t}:{type:"success",marks:[{name:"slice",position:r},{name:o,position:n}].concat(a.marks,s.marks),position:t+1})}return"]"!==e[t]?{type:"error",message:'Expected "]" after array expression',position:t}:{type:"success",marks:[{name:"square_bracket",position:r}].concat(a.marks),position:t+1}}case"|":if(t=eO(e,t+1),"{"===e[t]){let n=ej(e,t);return"error"===n.type||n.marks.unshift({name:"projection",position:r}),n}break;case"{":{let n=ej(e,t);return"error"===n.type||n.marks.unshift({name:"projection",position:r}),n}}return{type:"error",message:"Unexpected character in traversal",position:t}}function eS(e,t,r){let n=[];if(n.push({name:"func_call",position:t}),":"===e[r]&&":"===e[r+1]){n.push({name:"namespace",position:t}),n.push({name:"ident",position:t},{name:"ident_end",position:r}),r=eO(e,r+2);let a=eC(e,r,ev);if(!a)return{type:"error",message:"Expected function name",position:r};if(n.push({name:"ident",position:r},{name:"ident_end",position:r+a}),r=eO(e,r+a),"("!==e[r])return{type:"error",message:'Expected "(" after function name',position:r};r=eO(e,++r)}else n.push({name:"ident",position:t},{name:"ident_end",position:r}),r=eO(e,r+1);let a=r;if(")"!==e[r])for(;;){let t=e_(e,r,0);if("error"===t.type)return t;if(n=n.concat(t.marks),a=t.position,r=eO(e,t.position),","!==e[r]||(r=eO(e,r+1),")"===e[r]))break}return")"!==e[r]?{type:"error",message:'Expected ")" after function arguments',position:r}:(n.push({name:"func_args_end",position:a}),{type:"success",marks:n,position:r+1})}function ej(e,t){let r=[{name:"object",position:t}];for(t=eO(e,t+1);"}"!==e[t];){let n=t;if("..."===e.slice(t,t+3)){if(t=eO(e,t+3),"}"!==e[t]&&","!==e[t]){let a=e_(e,t,0);if("error"===a.type)return a;r.push({name:"object_splat",position:n}),r=r.concat(a.marks),t=a.position}else r.push({name:"object_splat_this",position:n})}else{let a=e_(e,t,0);if("error"===a.type)return a;let o=eO(e,a.position);if("str"===a.marks[0].name&&":"===e[o]){let s=e_(e,eO(e,o+1),0);if("error"===s.type)return s;r.push({name:"object_pair",position:n}),r=r.concat(a.marks,s.marks),t=s.position}else r=r.concat({name:"object_expr",position:t},a.marks),t=a.position}if(t=eO(e,t),","!==e[t])break;t=eO(e,t+1)}return"}"!==e[t]?{type:"error",message:'Expected "}" after object',position:t}:(t++,r.push({name:"object_end",position:t}),{type:"success",marks:r,position:t})}function eO(e,t){return t+eC(e,t,ex)}function eC(e,t,r){let n=r.exec(e.slice(t));return n?n[0].length:0}function eI(e,t,r){let n=r.exec(e.slice(t));return n?n[0]:null}function eT(e,t){return r=>t(e(r))}function eM(e){return t=>({type:"Map",base:t,expr:e({type:"This"})})}function eF(e,t){if(!t)return{type:"a-a",build:e};switch(t.type){case"a-a":return{type:"a-a",build:eT(e,t.build)};case"a-b":return{type:"a-b",build:eT(e,t.build)};case"b-b":return{type:"a-a",build:eT(e,eM(t.build))};case"b-a":var r;return{type:"a-a",build:eT(e,(r=t.build,e=>({type:"FlatMap",base:e,expr:r({type:"This"})})))};default:throw Error("unknown type: ".concat(t.type))}}function eP(e,t){if(!t)return{type:"b-b",build:e};switch(t.type){case"a-a":case"b-a":return{type:"b-a",build:eT(e,t.build)};case"a-b":case"b-b":return{type:"b-b",build:eT(e,t.build)};default:throw Error("unknown type: ".concat(t.type))}}function eN(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;switch(e.type){case"Projection":case"Filter":return{...e,base:eN(e.base,t),expr:eN(e.expr,t+1)};case"Parent":if(t-e.n<0)throw Error("Invalid use of parent operator (^). No parent n ".concat(e.n," at level ").concat(t,"."));return e;case"Parameter":throw Error("Function parameters are not allowed outside function declarations: ".concat(e.name));case"Array":return{...e,elements:e.elements.map(e=>({...e,value:eN(e.value,t)}))};case"PipeFuncCall":return{...e,base:eN(e.base,t),args:e.args.map(e=>eN(e,t))};case"Object":return{...e,attributes:e.attributes.map(e=>{switch(e.type){case"ObjectAttributeValue":case"ObjectSplat":return{...e,value:eN(e.value,t)};case"ObjectConditionalSplat":return{...e,condition:eN(e.condition,t),value:eN(e.value,t)};default:return e}})};case"FlatMap":case"Map":return{...e,expr:eN(e.expr,t),base:eN(e.base,t)};case"FuncCall":return{...e,args:e.args.map(e=>eN(e,t))};case"Tuple":return{...e,members:e.members.map(e=>eN(e,t))};case"Select":{let r=e.alternatives.map(e=>({...e,condition:eN(e.condition,t),value:eN(e.value,t)}));return e.fallback?{...e,alternatives:r,fallback:eN(e.fallback,t)}:{...e,alternatives:r}}case"SelectorNested":return{...e,base:eN(e.base,t),nested:eN(e.nested,t)};case"SelectorFuncCall":return{...e,arg:eN(e.arg,t)};case"AccessAttribute":case"AccessElement":case"ArrayCoerce":case"Asc":case"Desc":case"Deref":case"Group":case"Neg":case"Not":case"Slice":case"Pos":return e.base?{...e,base:eN(e.base,t)}:e;case"InRange":return{...e,base:eN(e.base,t),left:eN(e.left,t),right:eN(e.right,t)};case"OpCall":case"And":case"Or":return{...e,left:eN(e.left,t),right:eN(e.right,t)};case"Everything":case"This":case"Value":case"Context":return e;default:throw Error("Handle all cases: ".concat(e.type))}}let eU={"'":"'",'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"	"};class eD extends Error{constructor(...e){super(...e),this.name="GroqQueryError"}}function eV(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Set,t={group:e=>({type:"Group",base:e.process(t)}),everything:()=>({type:"Everything"}),this:()=>({type:"This"}),parent:()=>({type:"Parent",n:1}),dblparent:e=>({type:"Parent",n:e.process(t).n+1}),traverse(e){let r=e.process(t),a=[];for(;"traversal_end"!==e.getMark().name;)a.push(e.process(n));e.shift();let o=null;for(let e=a.length-1;e>=0;e--)o=a[e](o);if(("Everything"===r.type||"Array"===r.type||"PipeFuncCall"===r.type)&&(o=eF(e=>e,o)),null===o)throw Error("BUG: unexpected empty traversal");return o.build(r)},this_attr(e){let t=e.processString();return"null"===t?{type:"Value",value:null}:"true"===t?{type:"Value",value:!0}:"false"===t?{type:"Value",value:!1}:{type:"AccessAttribute",name:t}},neg:e=>({type:"Neg",base:e.process(t)}),pos:e=>({type:"Pos",base:e.process(t)}),add:e=>({type:"OpCall",op:"+",left:e.process(t),right:e.process(t)}),sub:e=>({type:"OpCall",op:"-",left:e.process(t),right:e.process(t)}),mul:e=>({type:"OpCall",op:"*",left:e.process(t),right:e.process(t)}),div:e=>({type:"OpCall",op:"/",left:e.process(t),right:e.process(t)}),mod:e=>({type:"OpCall",op:"%",left:e.process(t),right:e.process(t)}),pow:e=>({type:"OpCall",op:"**",left:e.process(t),right:e.process(t)}),comp(e){let r=e.process(t);return{type:"OpCall",op:e.processString(),left:r,right:e.process(t)}},in_range(e){let r=e.process(t),n="inc_range"===e.getMark().name;return e.shift(),{type:"InRange",base:r,left:e.process(t),right:e.process(t),isInclusive:n}},str(e){let t="";t:for(;e.hasMark();){let r=e.getMark();switch(r.name){case"str_end":t+=e.processStringEnd();break t;case"str_pause":t+=e.processStringEnd();break;case"str_start":e.shift();break;case"single_escape":{let r=e.slice(1);e.shift(),t+=eU[r];break}case"unicode_hex":e.shift(),t+=String.fromCharCode(parseInt(e.processStringEnd(),16));break;default:throw Error("unexpected mark: ".concat(r.name))}}return{type:"Value",value:t}},integer:e=>({type:"Value",value:Number(e.processStringEnd())}),float:e=>({type:"Value",value:Number(e.processStringEnd())}),sci:e=>({type:"Value",value:Number(e.processStringEnd())}),object(e){let t=[];for(;"object_end"!==e.getMark().name;)t.push(e.process(r));return e.shift(),{type:"Object",attributes:t}},array(e){let r=[];for(;"array_end"!==e.getMark().name;){let n=!1;"array_splat"===e.getMark().name&&(n=!0,e.shift());let a=e.process(t);r.push({type:"ArrayElement",value:a,isSplat:n})}return e.shift(),{type:"Array",elements:r}},tuple(e){let r=[];for(;"tuple_end"!==e.getMark().name;)r.push(e.process(t));return e.shift(),{type:"Tuple",members:r}},func_call(r){let n="global";"namespace"===r.getMark().name&&(r.shift(),n=r.processString());let o=r.processString();if("global"===n&&"select"===o){let e={type:"Select",alternatives:[]};for(;"func_args_end"!==r.getMark().name;)if("pair"===r.getMark().name){if(e.fallback)throw new eD("unexpected argument to select()");r.shift();let n=r.process(t),a=r.process(t);e.alternatives.push({type:"SelectAlternative",condition:n,value:a})}else{if(e.fallback)throw new eD("unexpected argument to select()");let n=r.process(t);e.fallback=n}return r.shift(),e}let s=[];for(;"func_args_end"!==r.getMark().name;){var i,c;(i=n,c=s.length,"diff"==i&&2==c&&["changedAny","changedOnly"].includes(o))?s.push(r.process(a)):s.push(r.process(t))}if(r.shift(),"global"===n&&("before"===o||"after"===o)&&"delta"===r.parseOptions.mode)return{type:"Context",key:o};if("global"===n&&"boost"===o&&!r.allowBoost)throw new eD("unexpected boost");let l=r.customFunctions["".concat(n,"::").concat(o)];if(void 0!==l){let t=e$(e),n=new ew(r.string,l.marks,r.customFunctions,{}).process(t);return eq(o,n.params.length,s.length),eG(n.body,e=>eN(e),e=>(function(e,t,r){if("Parameter"!==e.type)throw new eD("Expected parameter node, got ".concat(e.type));let n=t.findIndex(t=>t.name===e.name);if(-1===n)throw new eD("Missing argument for parameter ".concat(e.name," in function call"));return r[n]})(e,n.params,s))}let p=eg[n];if(!p)throw new eD("Undefined namespace: ".concat(n));let u=p[o];if(!u||(void 0!==u.arity&&eq(o,u.arity,s.length),void 0!==u.mode&&u.mode!==r.parseOptions.mode))throw new eD("Undefined function: ".concat(o));return{type:"FuncCall",namespace:n,name:o,args:s,func:u}},pipecall(e){let r=e.process(t);e.shift();let n="global";if("namespace"===e.getMark().name&&(e.shift(),n=e.processString()),"global"!==n)throw new eD("Undefined namespace: ".concat(n));let a=e.processString(),o=[],s=e.allowBoost;for("score"===a&&(e.allowBoost=!0);;){let r=e.getMark().name;if("func_args_end"===r)break;if("order"===a){if("asc"===r){e.shift(),o.push({type:"Asc",base:e.process(t)});continue}if("desc"===r){e.shift(),o.push({type:"Desc",base:e.process(t)});continue}}o.push(e.process(t))}e.shift(),e.allowBoost=s;let i=eb[a];if(!i)throw new eD("Undefined pipe function: ".concat(a));return i.arity&&eq(a,i.arity,o.length),{type:"PipeFuncCall",func:i,base:r,name:a,args:o}},pair(){throw new eD("unexpected =>")},and:e=>({type:"And",left:e.process(t),right:e.process(t)}),or:e=>({type:"Or",left:e.process(t),right:e.process(t)}),not:e=>({type:"Not",base:e.process(t)}),asc(){throw new eD("unexpected asc")},desc(){throw new eD("unexpected desc")},param(e){let t=e.processString();return e.parseOptions.params&&e.parseOptions.params.hasOwnProperty(t)?{type:"Value",value:e.parseOptions.params[t]}:{type:"Parameter",name:t}}},r={object_expr(e){if("pair"===e.getMark().name)return e.shift(),{type:"ObjectConditionalSplat",condition:e.process(t),value:e.process(t)};let r=e.process(t);return{type:"ObjectAttributeValue",name:function e(t){if("AccessAttribute"===t.type&&!t.base)return t.name;if("PipeFuncCall"===t.type||"Deref"===t.type||"Map"===t.type||"Projection"===t.type||"Slice"===t.type||"Filter"===t.type||"AccessElement"===t.type||"ArrayCoerce"===t.type||"Group"===t.type)return e(t.base);throw new eD("Cannot determine property key for type: ".concat(t.type))}(r),value:r}},object_pair(e){let r=e.process(t);if("Value"!==r.type)throw Error("name must be string");let n=e.process(t);return{type:"ObjectAttributeValue",name:r.value,value:n}},object_splat:e=>({type:"ObjectSplat",value:e.process(t)}),object_splat_this:()=>({type:"ObjectSplat",value:{type:"This"}})},n={square_bracket(e){let r=e.process(t),n=$(r);return n&&"number"===n.type?e=>(function(e,t){if(!t)return{type:"a-b",build:e};switch(t.type){case"a-a":case"b-a":return{type:"a-a",build:eT(e,t.build)};case"a-b":case"b-b":return{type:"a-b",build:eT(e,t.build)};default:throw Error("unknown type: ".concat(t.type))}})(e=>({type:"AccessElement",base:e,index:n.data}),e):n&&"string"===n.type?e=>eP(e=>({type:"AccessAttribute",base:e,name:n.data}),e):e=>eF(e=>({type:"Filter",base:e,expr:r}),e)},slice(e){let r="inc_range"===e.getMark().name;e.shift();let n=e.process(t),a=e.process(t),o=$(n),s=$(a);if(!o||!s||"number"!==o.type||"number"!==s.type)throw new eD("slicing must use constant numbers");return e=>eF(e=>({type:"Slice",base:e,left:o.data,right:s.data,isInclusive:r}),e)},projection(e){let r=e.process(t);return e=>(function(e,t){if(!t)return{type:"b-b",build:e};switch(t.type){case"a-a":return{type:"a-a",build:eT(eM(e),t.build)};case"a-b":return{type:"a-b",build:eT(eM(e),t.build)};case"b-a":return{type:"b-a",build:eT(e,t.build)};case"b-b":return{type:"b-b",build:eT(e,t.build)};default:throw Error("unknown type: ".concat(t.type))}})(e=>({type:"Projection",base:e,expr:r}),e)},attr_access(e){let t=e.processString();return e=>eP(e=>({type:"AccessAttribute",base:e,name:t}),e)},deref(e){let t=null;"deref_attr"===e.getMark().name&&(e.shift(),t=e.processString());let r=e=>t?{type:"AccessAttribute",base:e,name:t}:e;return e=>eP(e=>r({type:"Deref",base:e}),e)},array_postfix:()=>e=>eF(e=>({type:"ArrayCoerce",base:e}),e)},a={group:e=>e.process(a),everything(){throw Error("Invalid selector syntax")},this(){throw Error("Invalid selector syntax")},parent(){throw Error("Invalid selector syntax")},dblparent(){throw Error("Invalid selector syntax")},traverse(e){let r=e.process(a);for(;"traversal_end"!==e.getMark().name;)if("array_postfix"===e.getMark().name)e.shift(),r={type:"ArrayCoerce",base:r};else if("square_bracket"===e.getMark().name){e.shift();let n=e.process(t),a=$(n);if(a&&"number"===a.type)throw Error("Invalid array access expression");r=a&&"string"===a.type?{type:"AccessAttribute",base:r,name:a.data}:{type:"Filter",base:r,expr:n}}else if("attr_access"===e.getMark().name)e.shift(),r={type:"AccessAttribute",base:r,name:e.processString()};else if("tuple"===e.getMark().name||"group"===e.getMark().name){let t=e.process(a);if(!["AccessAttribute","ArrayCoerce","Filter","Group","Tuple","SelectorNested"].includes(t.type))throw Error("Unexpected result parsing nested selector: ".concat(t.type));r={type:"SelectorNested",base:r,nested:t}}else throw Error("Invalid selector syntax");return e.shift(),r},this_attr:e=>({type:"AccessAttribute",name:e.processString()}),attr_access(){throw Error("Invalid selector syntax")},neg(){throw Error("Invalid selector syntax")},pos(){throw Error("Invalid selector syntax")},add(){throw Error("Invalid selector syntax")},sub(){throw Error("Invalid selector syntax")},mul(){throw Error("Invalid selector syntax")},div(){throw Error("Invalid selector syntax")},mod(){throw Error("Invalid selector syntax")},pow(){throw Error("Invalid selector syntax")},comp(){throw Error("Invalid selector syntax")},in_range(){throw Error("Invalid selector syntax")},str(){throw Error("Invalid selector syntax")},integer(){throw Error("Invalid selector syntax")},float(){throw Error("Invalid selector syntax")},sci(){throw Error("Invalid selector syntax")},object(){throw Error("Invalid selector syntax")},array(){throw Error("Invalid selector syntax")},tuple(e){let t=[];for(;"tuple_end"!==e.getMark().name;)t.push(e.process(a));return e.shift(),{type:"Tuple",members:t}},func_call(e,r){let n=t.func_call(e,r);if("anywhere"===n.name&&1===n.args.length)return{type:"SelectorFuncCall",name:"anywhere",arg:n.args[0]};throw Error("Invalid selector syntax")},pipecall(){throw Error("Invalid selector syntax")},pair(){throw Error("Invalid selector syntax")},and(){throw Error("Invalid selector syntax")},or(){throw Error("Invalid selector syntax")},not(){throw Error("Invalid selector syntax")},asc(){throw Error("Invalid selector syntax")},desc(){throw Error("Invalid selector syntax")},param(){throw Error("Invalid selector syntax")}};return t}function eq(e,t,r){if("number"==typeof t){if(r!==t)throw new eD("Incorrect number of arguments to function ".concat(e,"(). Expected ").concat(t,", got ").concat(r,"."))}else if(t&&!t(r))throw new eD("Incorrect number of arguments to function ".concat(e,"()."))}function eG(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e=>e;if("Projection"===e.type){if("Parameter"===e.base.type)return{type:"Projection",base:r(e.base),expr:t(e.expr)};if("Deref"===e.base.type&&"Parameter"===e.base.base.type)return{type:"Projection",base:{type:"Deref",base:r(e.base.base)},expr:t(e.expr)}}if("Map"===e.type&&"ArrayCoerce"===e.base.type&&"Parameter"===e.base.base.type)return{type:"Map",base:{type:"ArrayCoerce",base:r(e.base.base)},expr:t(e.expr)};throw new eD('Unexpected function body, must be a projection. Got "'.concat(e.type,'"'))}class eH extends Error{constructor(e,t){super("Syntax error in GROQ query at position ".concat(e).concat(t?": ".concat(t):"")),this.name="GroqSyntaxError",this.position=e}}function eR(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=function(e){let t=0;t=eO(e,0);let r={};for(;t<e.length&&"fn"===e.substring(t,t+2);){let n=function(e,t){let r=t,n=[],a="",o="";if("fn"!==e.substring(r,r+2))return{type:"success",position:r,marks:n};n.push({name:"func_decl",position:t});let s=r=eO(e,r+2);if(!(a=eI(e,r,ev)))return{type:"error",message:"Expected function name",position:r};if(n.push({name:"ident",position:s},{name:"ident_end",position:r+a.length}),r=eO(e,r+a.length),"::"!==e.substring(r,r+2))return{type:"error",message:'Expected "::" after namespace',position:r};if(r=eO(e,r+2),!(o=eI(e,r,ev)))return{type:"error",message:"Expected function name",position:r};if(n.push({name:"ident",position:r},{name:"ident_end",position:r+o.length}),r=eO(e,r+o.length),"("!==e[r])return{type:"error",message:'Expected "("',position:r};for(r=eO(e,r+1);r<e.length&&")"!==e[r];){if("$"!==e[r])return{type:"error",message:'Parameter should start with "$"',position:r};let t=r,a=eI(e,++r,ev);if(!a)return{type:"error",message:"Expected function name",position:r};if(r+=a.length,n.push({name:"param",position:t},{name:"ident",position:t+1},{name:"ident_end",position:r}),r=eO(e,r),","===e[r])r=eO(e,r+1);else if(")"!==e[r])return{type:"error",message:'Expected "," or ")"',position:r}}if(")"!==e[r])return{type:"error",message:'Expected ")"',position:r};if(n.push({name:"func_params_end",position:r}),r=eO(e,r+1),"="!==e[r])return{type:"error",message:'Expected "="',position:r};r=eO(e,r+1);let i=e_(e,r,0);return"error"===i.type?i:(n=n.concat(i.marks),r=eO(e,i.position),";"!==e[r]?{type:"error",message:'Expected ";" after function declaration',position:r}:{type:"success",position:++r,marks:n,namespace:a,name:o})}(e,t);if("error"===n.type)return n;r["".concat(n.namespace,"::").concat(n.name)]=n,t=eO(e,n.position)}let n=e_(e,t,0);return"error"===n.type?n:(t=eO(e,n.position))!==e.length?(n.failPosition&&(t=n.failPosition-1),{type:"error",message:"Unexpected end of query",position:t}):(delete n.position,delete n.failPosition,n.customFunctions=r,n)}(e);if("error"===r.type)throw new eH(r.position,r.message);!function(e,t){for(let r in t){if(!t.hasOwnProperty(r))continue;let n=new ew(e,t[r].marks,t,{}),a=e$();eG(n.process(a).body,e=>eN(e))}}(e,r.customFunctions);let n=new ew(e,r.marks,r.customFunctions,t),a=eV();return n.process(a)}function e$(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Set;return{func_decl(t){let r=t.processString(),n=t.processString(),a="".concat(r,"::").concat(n);if(e.has(a))throw new eD("Recursive function definition detected for ".concat(a));let o=eV(new Set([...e,a])),s=[];for(;"func_params_end"!==t.getMark().name;){let e=t.process(o);if("Parameter"!==e.type)throw Error("expected parameter");s.push(e)}if(1!==s.length)throw new eD("Custom functions can only have one parameter");return t.shift(),{type:"FuncDeclaration",namespace:r,name:n,params:s,body:t.process(o)}}}}let{compare:eB}=new Intl.Collator("en");Symbol("groq-js.type.string_datetime"),n("typeEvaluator:scope:trace").log=console.log.bind(console),n("typeEvaluator:evaluate:trace").log=console.log.bind(console),n("typeEvaluator:evaluate:debug").log=console.log.bind(console),n("typeEvaluator:evaluate:warn"),Symbol("groq-js.type")}}]);